<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Particle Collision</title>
  </head>
  <body>
    <canvas width="400" height="400" id="canvas">Upgrade your browser.</canvas>
    <script type="text/javascript">
      const GRAVITY = 10;
      const COLLISION_POWER = 1000;
      const NUM_BALLS = 15;
      const EULER_STEPS = 20;

      class Particle {
        constructor(radius, x, y) {
          this.radius = radius;
          this.x = x;
          this.y = y;
          this.vx = 0;
          this.vy = 0;
        }

        updatePosition(dt) {
          this.x += this.vx * dt;
          this.y += this.vy * dt;
        }

        updateVelocity(particles, dt) {
          particles.forEach((p) => {
            if (p === this) {
              return;
            }
            const dist = this.distance(p);
            if (dist < this.radius + p.radius) {
              const fx = COLLISION_POWER * (this.x - p.x) / dist;
              const fy = COLLISION_POWER * (this.y - p.y) / dist;
              this.vx += dt * fx;
              this.vy += dt * fy;
            }
          });
          if (this.x - this.radius < 0) {
            this.vx += COLLISION_POWER * dt;
          } else if (this.x + this.radius >= 400) {
            this.vx -= COLLISION_POWER * dt;
          }
          if (this.y + this.radius > 400) {
            this.vy -= COLLISION_POWER * dt;
          } else if (this.y - this.radius < 0) {
            this.vy += COLLISION_POWER * dt;
          }
          this.vy += GRAVITY * dt;
        }

        distance(p1) {
          return Math.sqrt(Math.pow(this.x - p1.x, 2) + Math.pow(this.y - p1.y, 2));
        }
      }

      function drawParticles(particles) {
        const ctx = document.getElementById('canvas').getContext('2d');
        ctx.clearRect(0, 0, 400, 400);
        ctx.fillStyle = 'black';
        particles.forEach((p) => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
          ctx.fill();
        });
      }

      function initialize() {
        const particles = [];
        for (let i = 0; i < NUM_BALLS; ++i) {
          const p = new Particle(15, Math.random() * 400, Math.random() * 400);
          particles.push(p);
        }

        setInterval(() => {
          for (let i = 0; i < EULER_STEPS; ++i) {
            particles.forEach((p) => p.updatePosition(1 / 24 / EULER_STEPS));
            particles.forEach((p) => p.updateVelocity(particles, 1 / 24 / EULER_STEPS));
          }
          drawParticles(particles);
        }, 1000 / 24);
      }

      initialize();
    </script>
  </body>
</html>