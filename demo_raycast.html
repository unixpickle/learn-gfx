<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ray Casting Demo</title>
    <script src="deps/three.min.js"></script>
    <script src="src/subdivision.js"></script>
    <script src="src/raytrace.js"></script>
    <script src="src/monkey.js"></script>
  </head>
  <body>
    <canvas id="canvas" width="100" height="100" style="width: 200px; height: 200px;"></canvas>
    <script type="text/javascript">
      let object = null;

      function createObject() {
        let vertices = monkeyVertices();
        for (let i = 0; i < 2; ++i) {
          vertices = loopSubdivision(vertices);
        }
        vertices = vertices.map((x) => new THREE.Vector3(x[0], x[1], x[2]));
        const triangles = [];
        for (let i = 0; i < vertices.length; i += 3) {
          triangles.push(new TriangleRayObject(vertices[i], vertices[i + 1], vertices[i + 2]));
        }
        return new MeshRayObject(triangles);
      }

      function drawObject(angle) {
        let transformed = TransformRayObject.rotate(object, angle, angle, angle);
        transformed = TransformRayObject.translate(transformed, 0, -0.3, -2.0);

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const data = ctx.createImageData(canvas.width, canvas.height);
        
        const camera = new FrustumRayCamera(canvas.width, canvas.height, Math.PI / 2);
        const rays = camera.rayGrid();

        const light = new THREE.Vector3(0, 0, 0);
        const material = new PhongRayMaterial([0xff, 0xff, 0xff], 0.2);

        let dataIdx = 0;
        for (let y = 0; y < canvas.height; ++y) {
          for (let x = 0; x < canvas.width; ++x) {
            const ray = rays.shift();
            const intersection = transformed.intersection(ray);
            if (intersection !== null) {
              const color = material.color(ray, intersection, light);
              for (let i = 0; i < 3; ++i) {
                data.data[dataIdx++] = color[i];
              }
              data.data[dataIdx++] = 255;
            } else {
              for (let i = 0; i < 3; ++i) {
                data.data[dataIdx++] = 0;
              }
              data.data[dataIdx++] = 255;
            }
          }
        }
        ctx.putImageData(data, 0, 0);
      }

      function initialize() {
        object = createObject();
        drawObject(0);

        let angle = 0;
        setInterval(() => {
          angle += 0.1;
          drawObject(angle);
        }, 200);
      }

      initialize();
    </script>
  </body>
</html>